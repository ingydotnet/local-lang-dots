#!/bin/bash

main() {
    [ -n $LOCAL_LANG_ROOT ] || die "LOCAL_LANG_ROOT not set"
    [ -d $LOCAL_LANG_ROOT ] || die "dir '$LOCAL_LANG_ROOT' does not exist"
    [ -n "$1" ] || usage
    case $1 in
        '-?' | h | help) usage ;;
        w | which) which_local_lang ;;
        v | version) local_lang_version ;;
        install[-_]nvm) install_nvm ;;
        install[-_]perlbrew) install_perlbrew ;;
        install[-_]pythonbrew) install_pythonbrew ;;
        install[-_]rbenv) install_rbenv ;;
        install[-_]cpanm) install_cpanm ;;
        *) usage
    esac
}

install_nvm() {
    NVM_ROOT=$LOCAL_LANG_ROOT/nvm
    echo ">>> Installing 'nvm' for you"
    [ -e $NVM_ROOT ] && die 'nvm already installed'
    git clone git://github.com/creationix/nvm.git $NVM_ROOT
}

install_perlbrew() {
    PERLBREW_ROOT=$LOCAL_LANG_ROOT/perlbrew
    echo ">>> Installing 'perlbrew' for you"
    [ -e $PERLBREW_ROOT ] && die 'perlbrew already installed'
    echo "$(curl -kL http://install.perlbrew.pl | bash)"
}

install_pythonbrew() {
    PYTHONBREW_ROOT=$LOCAL_LANG_ROOT/pythonbrew
    echo ">>> Installing 'pythonbrew' for you"
    [ -e $PYTHONBREW_ROOT ] && die 'pythonbrew already installed'
    echo "$(curl -kL http://xrl.us/pythonbrewinstall | bash)"
}

install_rbenv() {
    RBENV_ROOT=$LOCAL_LANG_ROOT/rbenv
    echo ">>> Installing 'rbenv' for you"
    [ -e $RBENV_ROOT ] && die 'rbenv already installed'
    git clone git://github.com/sstephenson/rbenv.git $RBENV_ROOT
    git clone https://github.com/sstephenson/ruby-build.git \
        $RBENV_ROOT/plugins/ruby-build
}

install_cpanm() {
    for p in $(perlbrew list); do
        perlbrew exec --with $p 'curl -L http://cpanmin.us | perl - App::cpanminus'
    done
}

which_local_lang() {
    echo "Node.js: $(which node)"
    echo "Perl5:   $(which perl)"
    echo "Python2: $(which python)"
    echo "Ruby:    $(which ruby)"
}

local_lang_version() {
    # echo "Node:    $(node --version 2>&1 | perl -ne 'print $1 if /(\d+\.\d+\.\d+)/')"
    echo "Node:    $(get_version_string 'node --version')"
    echo "Perl5:   $(get_version_string 'perl -v')"
    echo "Python:  $(get_version_string 'python --version')"
    echo "Ruby:    $(get_version_string 'ruby -v')"
}

get_version_string() {
    command=$1
    echo "$($command 2>&1 | perl -ne 'print $1 if /(\d+\.\d+\.\d+)/')"
}

usage() {
    cat <<...
Usage:
    $(basename $0) <command>

Commands:
    v | version         Show all local language versions.
    w | which           Show paths to local lang binaries.
    install-nvm         Install NVM
    install-perlbrew    Install PerlBrew
    install-pythonbrew  Install PythonBrew
    install-rbenv       Install rbenv
    install-cpanm       Install cpanm for all Perl versions.

...
}

die() {
    echo "$1"
    exit 1
}

main $*
